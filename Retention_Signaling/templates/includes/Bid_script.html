<script>

    var start = document.getElementById('start_timer');
    var stop = document.getElementById('Exit');
    var pre_time;
    var countdown_time;
    var time;
    var player_id = {{player_id}};
    var max_price = {{group.fH}}

    before_auction();

    function before_auction() {
        console.log('hi');
        var countDownDate = new Date().getTime();
        pre_time = setInterval(function () {
            var now = new Date().getTime();

            // Find the distance between now and the count down date
            var distance = now - countDownDate;
            //
            var seconds = 3-Math.floor(distance / 1000);

            if (seconds <0)
            {
                message();
                clearInterval(pre_time);
            }
            }, 1000)
    }

    function countdown(){
        var countDownDate = new Date().getTime();
        pre_time = setInterval(function () {
            var now = new Date().getTime();
            console.log('ello');

            // Find the distance between now and the count down date
            var distance = now - countDownDate;
            //
            var seconds = 5-Math.floor(distance / 1000);

            if (seconds>=0){
                $('#exit-text').html('The Auction Will Start In: '+seconds)
            }

            if (seconds <0)
            {
                if (player_id ==1 ) {startAuction();}
                clearInterval(pre_time);
            }
            }, 1000)
    }

    function timer() {
        var countDownDate = new Date().getTime();
        time = setInterval(function () {
            var now = new Date().getTime();

            // Find the distance between now and the count down date
            var distance = now - countDownDate;
            //
            var seconds = Math.floor(distance / 1000);
            var expense = seconds * {{quantity}};

            // Display the result in the element with id="demo"
            if (seconds<max_price){
                document.getElementById("group_price").innerHTML = seconds;
                document.getElementById("expense").innerHTML = expense;
            }
            if (seconds >= max_price)
            {
                stopTime();
                $('#Exit').hide();
                $('#Next').show().prop('disabled', false);
                $('#proceed').html('Auction Over: Click to Proceed');
                $('#current').html('Final Price:').addClass('text-danger');
                $('#group_price').addClass('text-danger').html({{group.fH}});
                $('#seller_text').html('Auction Over: Click to Proceed');
                next_page();
                if (player_id==1) {expire();}
            }
        }, 1000)
    }

    function stopTime() {
        clearInterval(time)
    }


    function clickExit() {
        $('#Exit').toggle();
        exit($('#group_price').html());
        $('#Next').show()
    }

    $(document).ready(function () {
        $('#Exit').on('click', clickExit);
    });


    var seconds = Math.random() * 10000;
    exit_auction = function () {
        var exit_time = Math.random() * 70000;
        setTimeout(function () {
            document.getElementById('Exit').click()
        }, exit_time);

    };
    next_page = function(){
          var randTime = Math.random() * 10000+1000;
        setTimeout(function () {
            document.getElementById('Next').click();
            document.getElementById('seller_button').click();
            }, randTime);

    };

    window.onload = function () {

        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var wpsocket = new WebSocket(ws_scheme + '://' + window.location.host + "/price_increase/{{player.pk}}/{{ group.pk }}");

        // Handle any errors that occur.
        wpsocket.onerror = function (error) {
            console.log('WebSocket Error: ' + error);
        };

        // Show a connected message when the WebSocket is opened.
        wpsocket.onopen = function (event) {

            console.log('connected to oTree');
        };

        wpsocket.onclose = function (event) {
            console.log('disconnected from oTree');
        };

        wpsocket.onmessage = function (event) {
            var obj = jQuery.parseJSON(event.data);
            var start_timer = obj.start_timer;
            var stop_timer = obj.stop_timer;
            var auction_expired = obj.auction_expired;
            var price = obj.price;
            var change_count = obj.change_count;
            var count_down = obj.count_down;

            if (count_down){
                countdown();
            }

            if (start_timer) {
                timer();
                $('#exit-text').html('Exit');
                $('#seller_text').html('Please Wait');
                $('#Exit').prop('disabled', false);
                exit_auction()

            }

            if (change_count) {
                $('#num_in_auction').html(obj.count);
            }

            if (stop_timer) {
                stopTime();
                $('#Exit').hide();
                $('#Next').show().prop('disabled', false);
                $('#proceed').html('Auction Over: Click to Proceed');
                $('#current').html('Final Price:').addClass('text-danger');
                $('#group_price').addClass('text-danger').html(price);
                $('#seller_text').html('Auction Over: Click to Proceed');
                next_page()
            }

        };

        expire = function () {
            var msg = {
                'startAuction': false,
                'stop': true,
                'enter': false,
                'exit': false,
                'price': {{group.fH}}
            }
            if (wpsocket.readyState === wpsocket.OPEN) {
                wpsocket.send(JSON.stringify(msg))
            }
        };

        startAuction = function(){
            console.log('mate');
            var msg = {
                'startAuction': true,
                'exit': false,
                'stop': false,
                'enter': false
            }
            if (wpsocket.readyState === wpsocket.OPEN) {
                wpsocket.send(JSON.stringify(msg))
            }
        };

        message = function (what) {
            var msg = {
                    'enter': true,
                    'exit': false,
                    'stop': false,
                    'startAuction': false
                }
            if (player_id==1) {
                if (wpsocket.readyState === wpsocket.OPEN) {
                wpsocket.send(JSON.stringify(msg))
                }
            }

        };
        exit = function (price) {
            var msg = {
                    'stop': false,
                    'exit': true,
                    'enter': false,
                    'price': price,
                    'startAuction': false
                }
            ;
            if (wpsocket.readyState === wpsocket.OPEN) {
                wpsocket.send(JSON.stringify(msg))
            }
        };
    };


</script>